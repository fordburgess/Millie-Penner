<%= content_tag :div, id: 'cart-id', data: { cart_id: @current_cart.id } do %><% end %>
<style type="text/css">
  .cart-image-container {
    background-position: center;
    background-size: contain;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .cart-image-container:hover {
    cursor: pointer;
  }

  .cart-count {
    margin-top: -1px;
  }
</style>
<div class="flex items-center" style="z-index: 30; position: absolute; top: 10px; right: 10px;">
    <div class="mr-4 font-kameron">
        <% flash.each do |key, value| %>
            <div class="flash <%= key %> p-1 bg-white bg-opacity-80">
                <%= value %>
            </div>
        <% end %>
    </div>
    <div id="cart-icon" class="cart-image-container flex items-center h-10 w-10" style="background-image: url('<%= image_url('cart.png')%>');">
        <% if @current_cart.zines.length > 0 %>
            <p class="cart-count text-white font-kameron"><%= @current_cart.zines.length %></p>
        <% end %>      
    </div>    
</div>
<div id="cart-sidebar" class="h-screen w-[70vw] lg:w-[33vw] absolute right-0 bg-zinc-800 p-8 bg-opacity-90" style="transform: translateX(100%);">
    <div id="inner-cart" class="h-full flex flex-col justify-between">
        <div>
        <h1 class="font-lexendZetta text-3xl font-bold text-white mb-8">My Cart</h1>            
            <div id="cart-items">
                <% @current_cart.zines.each do |zine| %>
                    <div class="flex text-white mb-6 relative" id="zine-<%= zine.id %>" data="<%= zine.id %>">
                        <%= image_tag zine.cover_image, class: "mr-4", style: "max-height: 10rem; max-width: 5rem" %>
                        <div class="font-kameron">
                            <h2 class="mt-0 mb-4"><%= zine.title %></h2>
                            <p>Price: Â£<%= sprintf('%.2f', zine.price) %></p>
                        </div>
                        <%= button_to "X", remove_from_cart_path(zine), :method => :delete, id: "delete-button", data: { id: zine.id }, class: "absolute top-0 right-0 hover:cursor-pointer" %>
                    </div>
                <% end %>
            </div>
        </div>
        <% if @current_cart.zines.length > 0 %>
            <div class="flex flex-col">
                <%= link_to "Checkout", new_order_path, class: 'classic-button-1 w-full mb-4 text-center' %>                               
                <%= link_to "Clear all", empty_cart_path,:method => :delete, id: "clear-all-button", class: "classic-button-1 w-full bg-black text-white text-center" %>
            </div>
        <% end %>
    </div>
</div>    
<script>
    document.addEventListener('turbo:load', () => {
        var cartIcon = document.getElementById("cart-icon");        
        var cartSidebar = document.getElementById("cart-sidebar");
        var clearAllButton = document.getElementById("clear-all-button");
        var cartItems = document.getElementById("cart-items")
        var cartOpen = false;

        if (cartIcon) {
            cartIcon.addEventListener('click', (e) => {    
                e.stopPropagation();
            
                if (cartSidebar.style.transform == 'translateX(100%)') {
                    cartSidebar.style.display = 'block';
                    setTimeout(() => {
                        cartSidebar.style.transform = 'translateX(0%)';
                    }, 1)
                    cartOpen = true;         
                }
            })

            document.addEventListener('click', (e) => {
                if (cartOpen) {            
                    if (!cartSidebar.contains(e.target) && e.target.id !== 'delete-button') {                    
                        cartSidebar.style.transform = 'translateX(100%)'
                        cartOpen = false;
                    }
                }
            })
        }

        if (clearAllButton) {
            clearAllButton.addEventListener('click', () => {
                cartItems.innerHTML = '';
            })
        }
    })  

    document.addEventListener('turbo:load', function () {
        var cartItems = document.getElementById('cart-items');
        
        if (cartItems) {
            cartItems.addEventListener('click', (e) => {        
                if (e.target.id == 'delete-button') {            
                    var zineIdDelete = e.target.getAttribute('data-id');
                    var zineToRemove = document.getElementById(`zine-${zineIdDelete}`);                   
                    
                    cartItems.removeChild(zineToRemove);
    
                    fetch(`/remove_from_cart/${zineIdDelete}`, {
                        method: 'DELETE',
                        headers: { 
                            'Content-Type' : 'application/json', 
                            'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').getAttribute('content') 
                        }
                    })         
                }
            })
        }
    })
</script>